<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard NPS - Vegas Vigil√¢ncia</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #000;
      --card-bg: #111;
      --primary: #484a48;
      --text: #fff;
      --subtext: #ccc;
      --accent: #ffcc00;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    header {
      background-color: #0a0a0a;
      color: white;
      padding: 20px;
      text-align: center;
      border-bottom: 2px solid #5f6463;
    }

    header img {
      width: 100px;
      height: auto;
      margin-bottom: 10px;
    }

    h1 {
      font-size: 20px;
      color: var(--accent);
    }

    .container {
      padding: 20px;
      max-width: 1100px;
      margin: auto;
    }

    .grafico,
    .comentarios-section {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 0 12px rgba(0, 255, 204, 0.15);
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .top-bar input,
    .top-bar select {
      padding: 8px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #1a1a1a;
      color: white;
    }

    .nps-box {
      background: #1a1a1a;
      padding: 15px;
      border-left: 5px solid var(--primary);
      border-radius: 8px;
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 20px;
      color: var(--accent);
    }

    canvas {
      max-width: 400px; /* Reduzi um pouco para n√£o ocupar a tela toda */
      margin: 0 auto;
    }

    .comentarios-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 20px;
    }

    .card-comentario {
      background: #1a1a1a;
      border-left: 5px solid var(--primary);
      border-radius: 8px;
      padding: 15px;
      flex: 1 1 300px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }

    .card-comentario:hover {
      transform: scale(1.02);
    }

    .nota {
      font-size: 24px;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 5px;
    }

    .nome {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }

    .data-card {
      font-size: 11px;
      color: #666;
      margin-bottom: 8px;
    }

    .comentario {
      font-style: italic;
      color: var(--subtext);
      margin-bottom: 10px;
    }

    .extras {
      font-size: 12px;
      color: var(--subtext);
    }

    footer {
      background: #0a0a0a;
      color: white;
      text-align: center;
      padding: 15px;
      margin-top: 40px;
      font-size: 13px;
      border-top: 2px solid #5f6463;
    }

    @media (max-width: 600px) {
      .card-comentario {
        flex: 1 1 100%;
      }
      .top-bar {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>

<body>
  <header>
    <img src="./assets/logovegas.jpg" alt="Logo Vegas Vigil√¢ncia">
    <h1>Dashboard - Coment√°rios e Notas NPS</h1>
  </header>

  <div class="container">
    <div class="grafico">
      <h2 style="color:#fff; text-align: center; margin-bottom: 15px;">Distribui√ß√£o das Notas</h2>
      <canvas id="graficoPizza"></canvas>
    </div>

    <div class="comentarios-section">
      <div class="top-bar">
        <input type="text" id="buscaNome" placeholder="üîç Nome...">
        
        <div style="display: flex; gap: 5px; align-items: center;">
            <label style="font-size: 12px;">De:</label>
            <input type="date" id="dataInicio">
            <label style="font-size: 12px;">At√©:</label>
            <input type="date" id="dataFim">
        </div>

        <select id="filtroNota">
          <option value="">Nota: Todas</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option><option value="9">9</option>
          <option value="10">10</option>
        </select>

        <select id="filtroProduto">
          <option value="">Todos os Produtos</option>
          <option value="Alarme Monitorado">Alarme Monitorado</option>
          <option value="C√¢meras de Seguran√ßa">C√¢meras de Seguran√ßa</option>
          <option value="Rastreador Veicular">Rastreador Veicular</option>
          <option value="Vigil√¢ncia/Portaria">Vigil√¢ncia / Portaria</option>
          <option value="Bombeiro/Limpeza">Bombeiro / Limpeza</option>
        </select>
      </div>

      <div id="npsBox" class="nps-box">Calculando NPS...</div>

      <div class="comentarios-container" id="comentariosContainer"></div>
    </div>
  </div>

  <footer>
    <p>Monitoramento 24h ‚Ä¢ Seguran√ßa Residencial e Empresarial<br>
      ¬© 2025 Vegas Vigil√¢ncia</p>
  </footer>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyiGedsPHMibL87lObnRy_nKfHWxhhIOd1gJG14A1fkilz9Mw9dCGaJsxciYsbMIfZGbA/exec";
    let respostasOriginais = [];
    let meuGrafico = null;

    async function buscarDados() {
      const resposta = await fetch(API_URL);
      const dados = await resposta.json();
      
      return dados.reverse().map(item => {
        // Tenta pegar a data de campos comuns como 'carimbo', 'data' ou 'timestamp'
        const rawDate = item.carimbo || item.timestamp || item.data;
        return {
          nota: Number(item.nota),
          nome: item.nome?.trim() || "Sem nome",
          telefone: item.telefone || "-",
          produtos: item.produtos || "N√£o informado",
          comentarios: item.comentarios || "Sem coment√°rio",
          data: rawDate ? new Date(rawDate) : null
        };
      });
    }

    function gerarGraficoPizza(respostas) {
      const contagemNotas = new Array(11).fill(0);
      respostas.forEach(r => contagemNotas[r.nota]++);

      const ctx = document.getElementById('graficoPizza').getContext('2d');
      
      // Se j√° existir um gr√°fico, destr√≥i para criar um novo (necess√°rio para atualizar)
      if (meuGrafico) {
        meuGrafico.destroy();
      }

      meuGrafico = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: contagemNotas.map((_, i) => `Nota ${i}`),
          datasets: [{
            data: contagemNotas,
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
              '#9966FF', '#FF9F40', '#E7E9ED', '#8BC34A',
              '#795548', '#607D8B', '#3F51B5'
            ],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom', labels: { color: '#fff' } }
          }
        }
      });
    }

    function calcularNPS(respostas) {
      const total = respostas.length;
      if (total === 0) {
        document.getElementById("npsBox").textContent = "NPS: N/A (Nenhum dado no per√≠odo)";
        return;
      }
      const promotores = respostas.filter(r => r.nota >= 9).length;
      const detratores = respostas.filter(r => r.nota <= 6).length;
      const nps = Math.round(((promotores - detratores) / total) * 100);
      document.getElementById("npsBox").textContent =
        `NPS: ${nps} (Promotores: ${promotores}, Detratores: ${detratores}, Total: ${total})`;
    }

    function preencherComentarios(respostas) {
      const container = document.getElementById("comentariosContainer");
      container.innerHTML = "";

      if (respostas.length === 0) {
        container.innerHTML = "<p>Nenhum resultado encontrado para os filtros selecionados.</p>";
        return;
      }

      respostas.forEach(r => {
        const dataFormatada = r.data ? r.data.toLocaleDateString('pt-BR') : 'Data n√£o informada';
        const card = document.createElement("div");
        card.className = "card-comentario";
        card.innerHTML = `
          <div class="nota">Nota: ${r.nota}</div>
          <div class="nome">${r.nome}</div>
          <div class="data-card">Enviado em: ${dataFormatada}</div>
          <div class="comentario">"${r.comentarios}"</div>
          <div class="extras">
            Tel: ${r.telefone}<br>
            Produto(s): ${r.produtos}
          </div>`;
        container.appendChild(card);
      });
    }

    function aplicarFiltros() {
      const nomeFiltro = document.getElementById("buscaNome").value.toLowerCase();
      const notaFiltro = document.getElementById("filtroNota").value;
      const produtoFiltro = document.getElementById("filtroProduto").value;
      const dataInicio = document.getElementById("dataInicio").value;
      const dataFim = document.getElementById("dataFim").value;

      let filtradas = respostasOriginais;

      // Filtro por Nome
      if (nomeFiltro) {
        filtradas = filtradas.filter(r => r.nome.toLowerCase().includes(nomeFiltro));
      }

      // Filtro por Nota
      if (notaFiltro !== "") {
        filtradas = filtradas.filter(r => String(r.nota) === notaFiltro);
      }

      // Filtro por Produto
      if (produtoFiltro !== "") {
        filtradas = filtradas.filter(r => r.produtos.includes(produtoFiltro));
      }

      // Filtro por Data In√≠cio
      if (dataInicio) {
        const dInicio = new Date(dataInicio);
        dInicio.setHours(0, 0, 0, 0);
        filtradas = filtradas.filter(r => r.data && r.data >= dInicio);
      }

      // Filtro por Data Fim
      if (dataFim) {
        const dFim = new Date(dataFim);
        dFim.setHours(23, 59, 59, 999);
        filtradas = filtradas.filter(r => r.data && r.data <= dFim);
      }

      // Atualiza todos os componentes da tela com os dados filtrados
      preencherComentarios(filtradas);
      calcularNPS(filtradas);
      gerarGraficoPizza(filtradas);
    }

    // Adicionando ouvintes de eventos para todos os inputs
    document.getElementById("buscaNome").addEventListener("input", aplicarFiltros);
    document.getElementById("filtroNota").addEventListener("change", aplicarFiltros);
    document.getElementById("filtroProduto").addEventListener("change", aplicarFiltros);
    document.getElementById("dataInicio").addEventListener("change", aplicarFiltros);
    document.getElementById("dataFim").addEventListener("change", aplicarFiltros);

    // Inicializa√ß√£o
    buscarDados()
      .then(respostas => {
        respostasOriginais = respostas;
        preencherComentarios(respostas);
        calcularNPS(respostas);
        gerarGraficoPizza(respostas);
      })
      .catch(erro => {
        console.error("Erro ao buscar dados:", erro);
        document.querySelector(".container").innerHTML = "<p>Erro ao carregar os dados. Verifique a URL da API.</p>";
      });
  </script>
</body>

</html>