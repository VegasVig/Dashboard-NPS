<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard NPS - Vegas Vigil√¢ncia</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #000;
      --card-bg: #111;
      --primary: #484a48;
      --text: #fff;
      --subtext: #ccc;
      --accent: #ffcc00;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      background: #0a0a0a;
      padding: 20px;
      text-align: center;
      border-bottom: 2px solid #5f6463;
    }

    header img {
      width: 100px;
      margin-bottom: 10px;
    }

    h1 {
      color: var(--accent);
      font-size: 20px;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      padding: 20px;
    }

    .grafico,
    .comentarios-section {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 0 12px rgba(0, 255, 204, 0.15);
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    input,
    select {
      padding: 8px;
      background: #1a1a1a;
      border: 1px solid #333;
      color: white;
      border-radius: 6px;
    }

    .nps-box {
      background: #1a1a1a;
      padding: 15px;
      border-left: 5px solid var(--primary);
      color: var(--accent);
      font-weight: bold;
      margin-bottom: 20px;
      font-size: 18px;
    }

    .comentarios-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .card-comentario {
      background: #1a1a1a;
      border-left: 5px solid var(--primary);
      border-radius: 8px;
      padding: 15px;
      flex: 1 1 300px;
    }

    .nota {
      font-size: 22px;
      color: var(--accent);
      font-weight: bold;
    }

    .nome {
      font-weight: bold;
      margin: 5px 0;
    }

    .comentario {
      font-style: italic;
      color: var(--subtext);
      margin-bottom: 8px;
    }

    .extras {
      font-size: 12px;
      color: var(--subtext);
    }

    footer {
      text-align: center;
      padding: 15px;
      border-top: 2px solid #5f6463;
      font-size: 13px;
    }
  </style>
</head>

<body>

  <header>
    <img src="./assets/logovegas.jpg" alt="Vegas Vigil√¢ncia">
    <h1>Dashboard - Coment√°rios e Notas NPS</h1>
  </header>

  <div class="container">

    <div class="grafico">
      <h2>Distribui√ß√£o das Notas</h2>
      <canvas id="graficoPizza"></canvas>
    </div>

    <div class="comentarios-section">

      <div class="top-bar">
        <input type="text" id="buscaNome" placeholder="üîç Buscar por nome">
        <select id="filtroNota">
          <option value="">Filtrar por nota</option>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
        </select>

        <select id="filtroProduto">
          <option value="">Filtrar por produto</option>
          <option value="Alarme Monitorado">Alarme Monitorado</option>
          <option value="C√¢meras de Seguran√ßa">C√¢meras de Seguran√ßa</option>
          <option value="Rastreador Veicular">Rastreador Veicular</option>
          <option value="Vigil√¢ncia">Vigil√¢ncia</option>
        </select>
      </div>

      <div id="npsBox" class="nps-box">Calculando NPS...</div>

      <div id="comentariosContainer" class="comentarios-container"></div>

    </div>
  </div>

  <footer>
    Monitoramento 24h ‚Ä¢ Seguran√ßa Residencial e Empresarial<br>
    ¬© 2025 Vegas Vigil√¢ncia
  </footer>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyiGedsPHMibL87lObnRy_nKfHWxhhIOd1gJG14A1fkilz9Mw9dCGaJsxciYsbMIfZGbA/exec";
    let respostasOriginais = [];

    async function buscarDados() {
      const res = await fetch(API_URL);
      const json = await res.json();
      const dados = json.data || [];

      return dados.reverse().map(item => ({
        nota: Number(item.nota),
        nome: item.nome?.trim() || "Sem nome",
        telefone: item.telefone || "-",
        produtos: item.produtos || "N√£o informado",
        comentarios: item.comentarios || "Sem coment√°rio"
      }));
    }

    function gerarGraficoPizza(respostas) {
      try {
        const contagem = new Array(11).fill(0);

        respostas.forEach(r => {
          if (!isNaN(r.nota) && r.nota >= 0 && r.nota <= 10) {
            contagem[r.nota]++;
          }
        });

        new Chart(document.getElementById("graficoPizza"), {
          type: "pie",
          data: {
            labels: contagem.map((_, i) => `Nota ${i}`),
            datasets: [{
              data: contagem
            }]
          },
          options: {
            plugins: {
              legend: {
                position: "bottom",
                labels: { color: "#fff" }
              }
            }
          }
        });
      } catch (e) {
        console.error("Erro no gr√°fico:", e);
      }
    }

    function calcularNPS(respostas) {
      const total = respostas.length;
      const promotores = respostas.filter(r => r.nota >= 9).length;
      const detratores = respostas.filter(r => r.nota <= 6).length;
      const nps = total ? Math.round(((promotores - detratores) / total) * 100) : 0;

      document.getElementById("npsBox").textContent =
        `NPS: ${nps} | Promotores: ${promotores} | Detratores: ${detratores} | Total: ${total}`;
    }

    function preencherComentarios(lista) {
      const container = document.getElementById("comentariosContainer");
      container.innerHTML = "";

      if (!lista.length) {
        container.innerHTML = "<p>Nenhum resultado encontrado.</p>";
        return;
      }

      lista.forEach(r => {
        container.innerHTML += `
          <div class="card-comentario">
            <div class="nota">Nota ${r.nota}</div>
            <div class="nome">${r.nome}</div>
            <div class="comentario">"${r.comentarios}"</div>
            <div class="extras">
              Tel: ${r.telefone}<br>
              Produto(s): ${r.produtos}
            </div>
          </div>`;
      });
    }

    function aplicarFiltros() {
      const nome = buscaNome.value.toLowerCase();
      const nota = filtroNota.value;
      const produto = filtroProduto.value;

      let filtrado = respostasOriginais;

      if (nome) filtrado = filtrado.filter(r => r.nome.toLowerCase().includes(nome));
      if (nota) filtrado = filtrado.filter(r => String(r.nota) === nota);
      if (produto) filtrado = filtrado.filter(r => r.produtos.includes(produto));

      preencherComentarios(filtrado);
    }

    buscaNome.oninput = aplicarFiltros;
    filtroNota.onchange = aplicarFiltros;
    filtroProduto.onchange = aplicarFiltros;

    buscarDados()
      .then(respostas => {
        respostasOriginais = respostas;
        gerarGraficoPizza(respostas);
        calcularNPS(respostas);
        preencherComentarios(respostas);
      })
      .catch(err => {
        console.error(err);
        document.querySelector(".container").innerHTML = "<p>Erro ao carregar dados.</p>";
      });
  </script>

</body>
</html>
